<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeMatch - Find Your Perfect Bay Area Home</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --background: #f9fafb;
            --card-bg: #ffffff;
            --text: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary);
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Property Cards */
        .property-container {
            position: relative;
            height: 600px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .property-card {
            position: absolute;
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            cursor: grab;
            transition: transform 0.2s, opacity 0.2s;
        }

        .property-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .property-details {
            padding: 1.5rem;
        }

        .property-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .property-address {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .property-features {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Swipe Buttons */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .swipe-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.5rem;
        }

        .swipe-btn:hover {
            transform: scale(1.1);
        }

        .swipe-btn.reject {
            color: var(--danger);
            border-color: var(--danger);
        }

        .swipe-btn.like {
            color: var(--secondary);
            border-color: var(--secondary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                display: none;
            }
            
            .property-card {
                max-width: 90%;
            }
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .range-inputs {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .range-inputs label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .range-inputs input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            width: 150px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-grid label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-grid input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--background);
            border-radius: 0.5rem;
        }

        .checkbox-grid label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-grid input[type="checkbox"] {
            cursor: pointer;
        }

        .weights-container {
            display: grid;
            gap: 1rem;
        }

        .weight-slider {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: center;
            gap: 1rem;
        }

        .weight-slider input[type="range"] {
            width: 100%;
        }

        .save-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .save-btn:hover {
            background: var(--primary-dark);
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                üè† HomeMatch
            </div>
            <nav class="nav">
                <a href="#" class="nav-link active">Dashboard</a>
                <a href="#" class="nav-link">Saved</a>
                <a href="settings.html" class="nav-link">Settings</a>   <!-- NEW -->
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Error Display -->
        <div id="errorDisplay" style="display: none;"></div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">New Listings Today</div>
                <div class="stat-value" id="newListings">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Matches (75%+)</div>
                <div class="stat-value" id="matches">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Properties Viewed</div>
                <div class="stat-value" id="viewed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Properties Liked</div>
                <div class="stat-value" id="liked">0</div>
            </div>
        </div>

        <!-- Property Cards -->
        <div id="propertyContainer" class="property-container">
            <div class="loading" id="loadingState">
                <div class="loading-spinner"></div>
                <p style="margin-top: 1rem;">Loading properties...</p>
            </div>
            
            <div class="property-card" id="propertyCard" style="display: none;">
                <!-- Card content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Swipe Buttons -->
        <div class="swipe-buttons">
            <button class="swipe-btn reject" onclick="handleReject()">
                ‚ùå
            </button>
            <button class="swipe-btn like" onclick="handleLike()">
                ‚ù§Ô∏è
            </button>
        </div>
    </main>

    <script type = "module">
        // Settings object
        import { ALL_NEIGHBORHOODS, FAV_NEIGHBORHOODS } from './api/neighborhoods.js';

        let userSettings = {
            priceMin: 1800000,
            priceMax: 2300000,
            sqftMin: 1800,
            sqftMax: 3000,
            bedsMin: 3,
            bathsMin: 2,
            lawnMin: 200,
            kitchenAge: 10,
            neighborhoods: [
                'Willow Glen, San Jose, CA',
                'Cambrian, San Jose, CA',
                'Los Gatos, CA',
                'Cupertino, CA',
                'Palo Alto, CA',
                'Menlo Park, CA',
                'Mountain View, CA',
                'San Mateo, CA',
                'San Carlos, CA',
                'Belmont, CA'
            ],
            weights: {
                lawn: 30,
                kitchen: 25,
                commute: 20,
                safety: 15,
                view: 10
            }
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('homematchSettings');
            if (saved) {
                userSettings = JSON.parse(saved);
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            // Get values from form
            userSettings.priceMin = parseInt(document.getElementById('priceMin').value);
            userSettings.priceMax = parseInt(document.getElementById('priceMax').value);
            userSettings.sqftMin = parseInt(document.getElementById('sqftMin').value);
            userSettings.sqftMax = parseInt(document.getElementById('sqftMax').value);
            userSettings.bedsMin = parseInt(document.getElementById('bedsMin').value);
            userSettings.bathsMin = parseFloat(document.getElementById('bathsMin').value);
            userSettings.lawnMin = parseInt(document.getElementById('lawnMin').value);
            userSettings.kitchenAge = parseInt(document.getElementById('kitchenAge').value);
            
            // Get selected neighborhoods
            // Load settings from localStorage if present
            const saved = localStorage.getItem('homematchSettings');
            if (saved) {
            userSettings = JSON.parse(saved);
            } else {
            // first-time visitor ‚Üí start with the favourites
            userSettings.neighborhoods = [...FAV_NEIGHBORHOODS];
            }

            // Save to localStorage
            localStorage.setItem('homematchSettings', JSON.stringify(userSettings));
            
            // Close modal and reload properties
            closeSettings();
            alert('Settings saved! Reloading properties...');
            window.location.reload();
        }

        // Update weight display
        function updateWeight(type, value) {
            document.getElementById(`${type}Weight`).textContent = value;
            userSettings.weights[type] = parseInt(value);
            
            // Calculate total
            const total = Object.values(userSettings.weights).reduce((sum, w) => sum + w, 0);
            document.getElementById('totalWeight').textContent = total;
        }

        // Update nav to include settings link
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings on startup
            loadSettings();
            
            // Add settings link to nav (if not already there)
            const nav = document.querySelector('.nav');
            
                settingsLink.href = '#settings';
                settingsLink.className = 'nav-link';
                settingsLink.textContent = 'Settings';
                settingsLink.onclick = (e) => {
                    e.preventDefault();
                    openSettings();
                };
                nav.appendChild(settingsLink);
            }
        );
        
        // App State
        let currentIndex = 0;
        let properties = [];
        let stats = {
            viewed: 0,
            liked: 0
        };

        // Mock properties for demonstration
        const mockProperties = [
            {
                id: 1,
                price: 2150000,
                address: '1847 Willow Street',
                city: 'Willow Glen',
                image: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800',
                beds: 3,
                baths: 2.5,
                sqft: 1950,
                match: 92
            },
            {
                id: 2,
                price: 1995000,
                address: '523 Rose Avenue',
                city: 'Cambrian',
                image: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800',
                beds: 4,
                baths: 3,
                sqft: 2200,
                match: 88
            },
            {
                id: 3,
                price: 2250000,
                address: '789 Oak Lane',
                city: 'Los Gatos',
                image: 'https://images.unsplash.com/photo-1583608205776-bfd35f0d9f83?w=800',
                beds: 4,
                baths: 3,
                sqft: 2400,
                match: 94
            }
        ];

        // Initialize app
        async function init() {
            console.log('Initializing HomeMatch...');
            showLoading();
            
            try {
                // Try to fetch real properties
                await fetchProperties();
            } catch (error) {
                console.error('Error fetching properties:', error);
                showError('Unable to fetch live data. Using sample properties.');
                
                // Use mock data as fallback
                properties = mockProperties;
            }
            
            hideLoading();
            updateStats();
            
            if (properties.length > 0) {
                displayProperty(currentIndex);
            } else {
                showError('No properties found matching your criteria.');
            }
        }

        // Fetch properties from backend
        async function fetchProperties() {
            try {
                console.log('Fetching properties from all neighborhoods...');
                
                // Show loading with status
                document.getElementById('loadingState').innerHTML = `
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem;">Searching multiple neighborhoods...</p>
                `;
                
                // Call new multi-neighborhood endpoint
                const response = await fetch(`/api/properties?neighborhoods=${encodeURIComponent(JSON.stringify(userSettings.neighborhoods))}`);                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    console.log(`Found ${data.results.length} total properties!`);
                    
                    // Show neighborhood breakdown
                    if (data.neighborhoodCounts) {
                        console.log('Properties by neighborhood:');
                        data.neighborhoodCounts.forEach(n => {
                            if (n.count > 0) console.log(`  ${n.name}: ${n.count}`);
                        });
                    }
                    
                    // Transform to our format
                    properties = data.results.map(prop => ({
                        id: prop.zpid,
                        price: prop.price || 0,
                        address: prop.streetAddress || prop.address || 'No address',
                        city: prop.neighborhood || prop.city || 'Bay Area',
                        image: prop.imgSrc || 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800',
                        beds: prop.bedrooms || 3,
                        baths: prop.bathrooms || 2,
                        sqft: prop.livingArea || 2000,
                        match: Math.floor(Math.random() * 15) + 80,
                        zpid: prop.zpid,
                        url: prop.detailUrl
                    }));
                    
                    // Shuffle for variety
                    properties.sort(() => Math.random() - 0.5);
                    
                    return Promise.resolve();
                } else {
                    throw new Error('No properties found');
                }
            } catch (error) {
                console.error('Error fetching properties:', error);
                // Fallback to mock data
                properties = mockProperties;
                return Promise.resolve();
            }
        }       
        
        // Display property
        function displayProperty(index) {
            if (index >= properties.length) {
                showError('No more properties to show!');
                return;
            }

            const property = properties[index];
            const card = document.getElementById('propertyCard');
            
            card.innerHTML = `
                <img src="${property.image}" alt="Property" class="property-image">
                <div class="property-details">
                    <div class="property-price">$${property.price.toLocaleString()}</div>
                    <div class="property-address">${property.address}, ${property.city}</div>
                    <div class="property-features">
                        <div class="feature">üõèÔ∏è ${property.beds} beds</div>
                        <div class="feature">üöø ${property.baths} baths</div>
                        <div class="feature">üìè ${property.sqft} sqft</div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <strong>Match Score: ${property.match}%</strong>
                    </div>
                </div>
            `;
            
            card.style.display = 'block';
            stats.viewed++;
            updateStats();
        }

        // Handle swipe actions

        async function saveSwipe(property, vote) {
        console.log('saveSwipe called with:', { property, vote }); // ADD THIS
        try {
            const response = await fetch('/api/swipe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                zpid: property.id,
                vote,
                propertyData: property,
                userEmail: 'shan@example.com'
            })
            });
            const result = await response.json();
            console.log('Swipe saved:', result);
        } catch (error) {
            console.error('Failed to save swipe:', error);
        }
        }

        // Then update your handlers to verify they're calling it:
        function handleReject() {
        console.log('handleReject called'); // ADD THIS
        const property = properties[currentIndex];
        console.log('Current property:', property); // ADD THIS
        saveSwipe(property, false);
        console.log('Property rejected');
        nextProperty();
        }

        function handleLike() {
        console.log('handleLike called'); // ADD THIS
        const property = properties[currentIndex];
        console.log('Current property:', property); // ADD THIS
        saveSwipe(property, true);
        console.log('Property liked');
        stats.liked++;
        nextProperty();
        }

        function nextProperty() {
            currentIndex++;
            if (currentIndex < properties.length) {
                displayProperty(currentIndex);
            } else {
                showError('That\'s all for now! Check back later for more properties.');
            }
        }

        // Update stats display
        function updateStats() {
            document.getElementById('newListings').textContent = properties.length;
            document.getElementById('matches').textContent = properties.filter(p => p.match >= 75).length;
            document.getElementById('viewed').textContent = stats.viewed;
            document.getElementById('liked').textContent = stats.liked;
        }

        // UI helpers
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('propertyCard').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
            errorDiv.style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Start the app when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>